.. _reports:

Reports
========

When a feedback is accepted, after moderation by a moderator or automatically (see : :ref:`feedbacks-lifecycle`), a report a created.

An admin gets all his organization's reports with :

.. code-block:: bash

    GET /organizations/{organization}/reports

And a specific report with :

.. code-block:: bash

    GET /reports/{report}

.. _reports-lifecycle:

Life cycle
----------

When a new report is generated by a feedback, its state is NEW.

Below is a representation of each possible state for a report and the actions on that report leading to this state.

.. image:: ../../images/report_workflow.png

There is a unique endpoint to change a report's state :

.. code-block:: bash

    PATCH /reports/{report}/state

For example, to change the report's state from NEW to ACCEPTED, the admin will send the previous request with the following body :

.. code-block:: json

    {
        "transition": "accept"
    }

A report can only be closed (state CLOSED) if :

- Every operation linked to this report has been either resolved or refused (see paragraph below :ref:`reports-interventions`).
- Every report delegated to a partner organization from the original report must be closed (see paragraph below :ref:`reports-delegation`).

.. _reports-interventions:

Interventions
-------------

An intervention is an action assigned to a member of the organization in relation with a report.

This endpoint sends back all operations resulting from a report :

.. code-block:: bash

    GET /reports/{report}/operations

**Creation and modification of an intervention**

An admin creates an intervention on a report with this request :

.. code-block:: bash

    POST /operations

.. code-block:: json

    {
        "description":"Intervention's description",
        "name":"Intervention's name",
        "report":"cb7118b5-a821-4cf2-9475-0c0d0efdb8d0"
    }

A newly created intervention has the state NEW.

One or more images can be added to an intervention :

.. code-block:: bash

    POST /operations/{operation}/images

.. code-block:: json

    {
        "image":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAIAAAACDbGyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4QIVDRUfvq7u+AAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAAUSURBVAjXY3wrIcGABJgYUAGpfABZiwEnbOeFrwAAAABJRU5ErkJggg=="
    }

The description of an intervention can be modified with the request :

.. code-block:: bash

    PATCH /operations/{operation}

.. code-block:: json

    {
        "description": "New description"
    }

**Assignment**

To assign an intervention to a member, the admin sends the following request :

.. code-block:: bash

    POST /operations/{operation}/assign
.. code-block:: bash

    {
        "member": "{member}",
    }

where {member} is the member's id to assign the intervention to.

**Accept or refuse**

Once assigned, the intervention can be either accepted or refused, by the assigned member or by the admin.
To accept the intervention :

.. code-block:: bash

    PATCH /operations/{operation}/state

.. code-block:: json

    {
        "transition": "accept"
    }

**In progress and closing intervention**

After being accepted, the intervention will be changed to "in progress" then "resolved", either by the assigned member or the admin.

**Life cycle of an intervention**

.. image:: ../../images/operation_workflow.png

**Comments**

It is possible to comment an intervention :

.. code-block:: bash

    POST /operations/{operation}/comments

.. code-block:: json

    {
        "text":"My comment"
    }

To get all comments on an intervention :

.. code-block:: bash

    GET /operations/{operation}/comments

**Logs of an intervention**

An admin can see the history of an intervention :

.. code-block:: bash

    GET /operations/{operation}/logs

.. _reports-delegation:

Delegation
----------

An admin can delegate a report to a partner organization.

See : :ref:`organizations-relationships`

To delegate a report, an admin sends the following request :

.. code-block:: bash

    POST /organizations/{organization}/delegates

.. code-block:: json

    {
        "report":"cb7118b5-a821-4cf2-9475-0c0d0efdb8d0",
        "organization":"a31d9ab7-9476-45f2-8cc7-033bf40bbcfa"
    }

where {organization} is the organization's id delegating the report.
And a31d9ab7-9476-45f2-8cc7-033bf40bbcfa is the receiving organization's id.

Delegating a report doesn't mean this report is transfered, the initial report isn't modified but a new "child" report is created and attributed to the partner organization. This new report will be treated by the partner organization the same way every other report is: state change, interventions, assignments, etc, until it is closed.

The partner organization may itself delegate this report to one of its partners and so on. For the initial report to be closed, the child must be closed.

.. _reports-export:

Export
-----

An admin can export every report from his organization to the Excel format:

.. code-block:: bash

    POST /organizations/{organization}/reports/exports

An archive containing the Excel file listing all reports and the associated images will be send to the authenticated admin.
